<!DOCTYPE html>
<html>
    <head>
		<meta charset="UTF-8">
		<title>PDF文件发布</title>
        <meta name="viewport" content="initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- favicon -->
        <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
        <!-- bootstrap framework -->
		<link href="assets/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
        <!-- icon sets -->
            <!-- elegant icons -->
                <link href="assets/icons/elegant/style.css" rel="stylesheet" media="screen">
            <!-- elusive icons -->
                <link href="assets/icons/elusive/css/elusive-webfont.css" rel="stylesheet" media="screen">
            <!-- flags -->
                <link rel="stylesheet" href="assets/icons/flags/flags.css">
            <!-- scrollbar -->
                <link rel="stylesheet" href="assets/lib/malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.css">
        <!-- google webfonts -->
		<link href='http://fonts.googleapis.com/css?family=Open+Sans&amp;subset=latin,latin-ext' rel='stylesheet' type='text/css'>
        <!-- main stylesheet -->
		<link href="assets/css/main.min.css" rel="stylesheet" media="screen" id="mainCss">
        <!-- moment.js (date library) -->
        <script src="assets/js/moment-with-langs.min.js"></script>
    </head>
    <body class="side_menu_active side_menu_expanded">
        <div id="page_wrapper">

            <!-- header -->
            <header id="main_header">
            </header>

            <!-- breadcrumbs -->
            <nav id="breadcrumbs">
                <ul>
                    <li><a href="dashboard.html">首页</a></li><li><span>文件管理</span></li><li><span>图片上传</span></li>
                </ul>
            </nav>

            <!-- main content -->
            <div id="main_wrapper">
                <div class="container-fluid">
                    <fieldset>
                        <legend><span>图片上传</span></legend>
                    </fieldset>
                    <div class="row">
                        <div class="col-lg-6">
                            <label for="serverUrl">上传至服务器路径:</label>
                            <input type="text" id="serverUrl" name="serverUrl" value="G:/UPLOADS" class="form-control">
                            <br/>
                            <input type="file" name="fileToUpload" id="fileToUpload"/>
                            <!-- multiple="multiple" -->
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <button class="btn" type="button" id="upload" onclick="upload()">上&nbsp;&nbsp;传</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- main menu -->
            <nav id="main_menu">
            </nav>

        </div>

        <script src="assets/js/main.entry.js"></script>
		<!-- JavaScript脚本程序 -->
		<script type="text/javascript">
		var result;
		var selectedArr = new Array();
		
		/**
		*维护数组函数 之 扩容 
		*/
		function addArray(id) {
			//增加一个元素，为数组扩容
			var len = selectedArr.length;
			selectedArr[len]=id;
		}
		
		/**
		*维护数组函数 之 缩容 
		*/
		function reduceArray(id){
			//减少一个元素,为数组缩容
			var middleware = new Array();
			var index = 0;
			for(var i=0; i<selectedArr.length; i++) {
				var one = selectedArr[i];
				if(one!=id) {
					middleware[index] = one;
					index++;
				}
			}
			selectedArr = middleware;
		}
		
		$(document).ready(function(){ 
			//查询联想的结果
			result = select();
			console.log(result.length);
			console.log(result[0].tag);
		});
		
		$("#association").bind('input porpertychange',function(){
			var value = $("#association").val();
			associateSearch(value);
		});
		
		function associateSearch(value) {
			//初始化
			var flag = false;
			$("#association-div").css('display','none');
			$("#association-div").css('border','1px solid #ccc');
			$("#association-div").empty();
			var ul = '<ul style="list-style-type:none;padding-left:3px;">';
			for(var i=0; i<result.length; i++) {
				if(result[i].tag.toLocaleUpperCase().indexOf(value.toLocaleUpperCase())>=0) {
					ul += '<li id="'+result[i].id+'"><a href="javascript:addTag(\''+result[i].id+'\',\''+result[i].tag+'\');">'+result[i].tag+'</a></li>';
					flag = true;
				}
			}
			ul += '</ul>';
			$("#association-div").append($(ul));
			if(!flag) {
				var btn = '<button class="btn-primary btn" type="button" onclick="insertTag()">添加</button>';
				$("#association-div").css('border','0');
				$("#association-div").css('display','block');
				$("#association-div").append($(btn));
			}
			if(flag) {
				$("#association-div").css('display','block');
				flag = false;
			}
		}
		
		/**
		* 新增标签
		*/
		function insertTag() {
			var tag = $("#association").val();
			var id = uuid();
			var li = '<li id="selected'+id+'"><a href="javascript:delTag(\''+id+'\');">'+tag+'<i class="icon_close_alt bs_ttip"></i></a></li>';
			$("#select_tags").append($(li));
			addArray("selected"+id);
		}
		
		/**
		* 添加标签
		*/
		function addTag(id,tag) {
			console.log(id);
			console.log(tag);
			var li = '<li id="selected'+id+'"><a href="javascript:delTag(\''+id+'\');">'+tag+'<i class="icon_close_alt bs_ttip"></i></a></li>';
			$("#select_tags").append($(li));
			addArray("selected"+id);
		}
		
		/**
		* 删除标签
		*/
		function delTag(id) {
			console.log(id);
			$("#selected"+id+"").remove();
			reduceArray("selected"+id);
		}
		
		function select() {
			//组装传输对象
			var loginInfoValue = new Object();
			var params = {
				action:'select-tag',
				data:""
			}; 
			var res;
			//AJAX请求	
			$.ajax({
				async:false, //禁止异步
				url : "/DCMServer/goodLuckToDd/back",
				type : "post",
				data : {
					params: JSON.stringify(params)
				},
				dataType : "json",
				success : function(json) {
					/*
					$("#message").html(json.message);
					//成功跳转
					if(json.status.toString() == '1'){
						 window.location.href="index.html";
					}
					*/
					console.log("成功 >>> ");
					console.log(json);
					res = json;
				},
				error : function(json) {
					/*
					alert(json.message);
					$("#message").html(json.message);
					*/
					console.log("失败");
					console.log(json);
					res = json;
				}
			});
			return res;
		}
		
		function insertArtTag() {
			var params = {
				action: 'insert-ArticlesTags',
				data: {}
			};
			console.log(JSON.stringify(params));
			$.ajax({
				async:false, //禁止异步
				url : "/DCMServer/goodLuckToDd/back",
				type : "post",
				data : {
					params: JSON.stringify(params)
				},
				dataType : "json",
				success : function(json) {
					/*
					$("#message").html(json.message);
					//成功跳转
					if(json.status.toString() == '1'){
						 window.location.href="index.html";
					}
					*/
					console.log("成功 >>> ");
					console.log(json);
					
				},
				error : function(json) {
					/*
					alert(json.message);
					$("#message").html(json.message);
					*/
					console.log("失败");
					console.log(json);
				}
			});
		}
		
		/**
		* 执行上传操作，上传文件是一个流程，流程如下：
		* 1.先处理tags数据到tags表 
		* 2.处理pdf文件信息到articles表 
		* 3.增加关联数据到articles_tags表 
		* 4.恢复sign值,update操作
		*/
		function upload() {
			//1.获取文本信息，先处理文本信息
			console.log(selectedArr);
			var arr = new Array();
			var arrNew = new Array();
			var index = 0;
			var indexNew = 0;
			for(var i=0; i<selectedArr.length; i++) {
				//对于新增的数据和选中历史tags数据作区分
				if(selectedArr[i].indexOf("_")>0) {
					arrNew[indexNew] = $("#"+selectedArr[i]+" a").text();
					indexNew++;
				} else {
					arr[index] = $("#"+selectedArr[i]+" a").text();
					index++;
				}
			}
			//获取input框中的服务器上传路径值
			var serverUrl = $("#serverUrl").val();
			var dataValue = {
				tags: {
					oldTags: arr,
					newTags: arrNew
				},
				path: serverUrl
			};
			var params = {
				action: 'insert-tag',
				data: {
					tags: {
						oldTags: arr,
						newTags: arrNew
					},
					path: serverUrl
					}
			};
			console.log(JSON.stringify(params));
			$.ajax({
				async:false, //禁止异步
				url : "/DCMServer/goodLuckToDd/back",
				type : "post",
				data : {
					params: JSON.stringify(params)
				},
				dataType : "json",
				success : function(json) {
					/*
					$("#message").html(json.message);
					//成功跳转
					if(json.status.toString() == '1'){
						 window.location.href="index.html";
					}
					*/
					console.log("成功 >>> ");
					console.log(json);
					ajaxFileUpload();//上传文件
				},
				error : function(json) {
					/*
					alert(json.message);
					$("#message").html(json.message);
					*/
					console.log("失败");
					console.log(json);
				}
			});
		}
		
		/**
		* 页面初始化
		*/
		$(function(){
			//查询联想的结果
			console.log("开始执行 ");
		});
		
	    //测试
	    function ajaxFileUpload() {
	    	var serverUrl = $("#serverUrl").val();
	    
	    	
			$.ajaxFileUpload({
				url : '/DCMServer/goodLuckToDd/upload-file',
				secureuri : false,
				fileElementId : 'fileToUpload',
				dataType : 'JSON',
				data : {},
				success : function(data, status) {
					console.log(data);
					console.log(status);
					//$('#viewImg').attr('src',data.picUrl);
					insertArtTag();
				},
				error : function(data, status, e) {
					console.log(data);
					console.log(status);
					console.log(e);
					alert('上传出错');
				}
			})
			return false;
		}
	    
	    function uuid() {
	        var s = [];
	        var hexDigits = "0123456789abcdef";
	        for (var i = 0; i < 36; i++) {
	            s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
	        }
	        s[14] = "4";  // bits 12-15 of the time_hi_and_version field to 0010
	        s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);  // bits 6-7 of the clock_seq_hi_and_reserved to 01
	        s[8] = s[13] = s[18] = s[23] = "_";
	     
	        var uuid = s.join("");
	        return uuid;
	    }      
		
		</script>
		
    </body>

</html>
