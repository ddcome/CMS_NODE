<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>新增内容</title>
    <meta name="viewport" content="initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">

    <!-- bootstrap framework -->
    <link href="assets/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">

    <!--Umeditor样式加载-->
    <link href="assets/ueditor/themes/default/css/ueditor.css" type="text/css" rel="stylesheet">

    <!-- icon sets -->
    <!-- elegant icons -->
    <link href="assets/icons/elegant/style.css" rel="stylesheet" media="screen">
    <!-- elusive icons -->
    <link href="assets/icons/elusive/css/elusive-webfont.css" rel="stylesheet" media="screen">
    <!-- flags -->
    <link rel="stylesheet" href="assets/icons/flags/flags.css">
    <!-- scrollbar -->
    <link rel="stylesheet" href="assets/lib/malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.css">


    <!-- google webfonts -->
    <link href='assets/css/fonts.googleapis.css' rel='stylesheet' type='text/css'>

    <!-- main stylesheet -->
    <link href="assets/css/main.min.css" rel="stylesheet" media="screen" id="mainCss">


    <!-- moment.js (date library) -->
    <script src="assets/js/moment-with-langs.min.js"></script>

</head>
<body class="side_menu_active side_menu_expanded">
<div id="page_wrapper">

    <!-- header -->
    <header id="main_header">
    </header>

    <!-- breadcrumbs -->
    <nav id="breadcrumbs">
        <ul>
            <li><a href="dashboard.html">首页</a></li>
            <li><span>内容管理</span></li>
            <li><span>新增内容</span></li>
        </ul>
    </nav>

    <!-- main content -->
    <div id="main_wrapper">
        <div class="container-fluid">
            <fieldset>
                <legend><span>发布内容</span></legend>
            </fieldset>
            <div class="row">
                <div class="col-lg-6">
                    <label for="article_title">内容标题:</label>
                    <input type="text" id="article_title" class="form-control">
                </div>
            </div>
            <div class="row">
                <div class="col-lg-6">
                    <label for="article_author">作者:</label>
                    <input type="text" id="article_author" class="form-control" readonly="readonly" value="ddcome">
                </div>
            </div>

            <div class="row">

                <div class="col-lg-3">
                    <label>选择标签:</label>
                    <input type="text" id="association" name="association" class="form-control" placeholder="请搜索关键词...">
                    <div id="association-div"
                         style="width:100%; border:1px solid #ccc;height:100px;overflow:auto;display:none;">
                    </div>
                </div>
                <div class="col-lg-3">
                    <label>选中的标签：</label><br>
                    <ul id="select_tags" style="list-style-type:none;padding-left:3px;">
                    </ul>
                </div>

            </div>

            <div class="row">
                <div class="col-lg-12">
                    <!--Ueditor编辑器-->
                    <script id="editor" type="text/plain" style="width:1024px;height:500px;"></script>
                    <
                    p > < /p>
                    </script>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12">
                    <button id="publish_btn" class="btn" type="button">发&nbsp;&nbsp;布</button>&nbsp;&nbsp;&nbsp;&nbsp;
                    <button class="btn" type="button">取&nbsp;&nbsp;消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- main menu -->
    <nav id="main_menu">
    </nav>

</div>

<!-- jQuery -->
<script src="assets/js/jquery.min.js"></script>
<!--加载菜单-->
<script src="assets/js/main_menu.js"></script>
<!-- jQuery Cookie -->
<script src="assets/js/jqueryCookie.min.js"></script>
<!-- Bootstrap Framework -->
<script src="assets/bootstrap/js/bootstrap.min.js"></script>
<!-- retina images -->
<!--<script src="assets/js/retina.min.js"></script>-->
<!-- switchery -->
<script src="assets/lib/switchery/dist/switchery.min.js"></script>
<!-- typeahead -->
<script src="assets/lib/typeahead/typeahead.bundle.min.js"></script>
<!-- fastclick -->
<script src="assets/js/fastclick.min.js"></script>
<!-- match height -->
<script src="assets/lib/jquery-match-height/jquery.matchHeight-min.js"></script>
<!-- scrollbar -->
<script src="assets/lib/malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.concat.min.js"></script>

<!-- Yukon Admin functions -->
<script src="assets/js/yukon_all.js"></script>

<!--加载页头-->
<script src="assets/js/main_header.js"></script>
<!--加载菜单-->
<script src="assets/js/main_menu.js"></script>

<!--Ueditor编辑器-->
<script type="text/javascript" charset="utf-8" src="assets/ueditor/ueditor.config.js"></script>
<script type="text/javascript" charset="utf-8" src="assets/ueditor/ueditor.all.js"></script>
<!--建议手动加在语言，避免在ie下有时因为加载语言失败导致编辑器加载失败-->
<!--这里加载的语言文件会覆盖你在配置项目里添加的语言类型，比如你在配置项目里配置的是英文，这里加载的中文，那最后就是中文-->
<script type="text/javascript" charset="utf-8" src="assets/ueditor/lang/zh-cn/zh-cn.js"></script>

<!-- jBox -->
<script src="assets/lib/jBox-0.3.0/Source/jBox.min.js"></script>


<script type="text/javascript">
    //实例化编辑器
    //建议使用工厂方法getEditor创建和引用编辑器实例，如果在某个闭包下引用该编辑器，直接调用UE.getEditor('editor')就能拿到相关的实例
    var ue = UE.getEditor('editor');

    var result;
    var selectedArr = new Array();


    /**
     * 文章发布调用
     */
    $("#publish_btn").click(function () {
        console.log("点击了发布");


        var arr = new Array();
        var arrNew = new Array();
        var index = 0;
        var indexNew = 0;
        for (var i = 0; i < selectedArr.length; i++) {
            //对于新增的数据和选中历史tags数据作区分
            if (selectedArr[i].indexOf("_") > 0) {
                arrNew[indexNew] = $("#" + selectedArr[i] + " a").text();
                indexNew++;
            } else {
                arr[index] = $("#" + selectedArr[i] + " a").text();
                index++;
            }
        }
        //获取input框中的文章名
        var title = $("#article_title").val();
        var author = $("#article_author").val();
        var content = UE.getEditor('editor').getContent();


        console.log(title);
        console.log(author);
        console.log(arrNew);
        console.log(arr);
        console.log(content);

        insert(title, arr, arrNew, author, content);


    });

    /**
     * 数据新增的函数
     */
    function insert(title, arr, arrNew, author, content) {

        var params = {
            action: 'insert-articles',
            data: {
                title: title,
                tags: {
                    oldTags: arr,
                    newTags: arrNew
                },
                author: author,
                content: content
            }
        };
        console.log(JSON.stringify(params));
        $.ajax({
            async: false, //禁止异步
            url: "/DCMServer/goodLuckToDd/back",
            type: "post",
            data: {
                params: JSON.stringify(params)
            },
            dataType: "json",
            success: function (json) {
                /*
                $("#message").html(json.message);
                //成功跳转
                if(json.status.toString() == '1'){
                     window.location.href="index.html";
                }
                */
                console.log("成功 >>> ");
                console.log(json);
                //ajaxFileUpload();//上传文件

                //最后，进行提示信息的展示
                new jBox('Notice', {
                    attributes: {
                        x: 'right',
                        y: 'bottom'
                    },
                    theme: 'NoticeBorder',
                    color: 'green',
                    audio: 'assets/lib/jBox-0.3.0/Source/audio/bling2',
                    volume: '100',
                    stack: false,
                    autoClose: 3000,
                    animation: {
                        open: 'slide:bottom',
                        close: 'slide:left'
                    },
                    onInit: function () {
                        this.options.title = '反馈';
                        this.options.content = '数据保存成功！';
                    }
                });
            },
            error: function (json) {
                /*
                alert(json.message);
                $("#message").html(json.message);
                */
                console.log("失败");
                console.log(json);
            }
        });
    }

    /**
     *维护数组函数 之 扩容
     */
    function addArray(id) {
        //增加一个元素，为数组扩容
        var len = selectedArr.length;
        selectedArr[len] = id;
    }

    /**
     *维护数组函数 之 缩容
     */
    function reduceArray(id) {
        //减少一个元素,为数组缩容
        var middleware = new Array();
        var index = 0;
        for (var i = 0; i < selectedArr.length; i++) {
            var one = selectedArr[i];
            if (one != id) {
                middleware[index] = one;
                index++;
            }
        }
        selectedArr = middleware;
    }

    $(document).ready(function () {
        //查询联想的结果
        // result = select();
        // console.log(result.length);
        // console.log(result[0].tag);
    });

    $("#association").bind('input porpertychange', function () {
        var value = $("#association").val();
        associateSearch(value);
    });

    function associateSearch(value) {
        //初始化
        var flag = false;
        $("#association-div").css('display', 'none');
        $("#association-div").css('border', '1px solid #ccc');
        $("#association-div").empty();
        var ul = '<ul style="list-style-type:none;padding-left:3px;">';
        for (var i = 0; i < result.length; i++) {
            if (result[i].tag.toLocaleUpperCase().indexOf(value.toLocaleUpperCase()) >= 0) {
                ul += '<li id="' + result[i].id + '"><a href="javascript:addTag(\'' + result[i].id + '\',\'' + result[i].tag + '\');">' + result[i].tag + '</a></li>';
                flag = true;
            }
        }
        ul += '</ul>';
        $("#association-div").append($(ul));
        if (!flag) {
            var btn = '<button class="btn-primary btn" type="button" onclick="insertTag()">添加</button>';
            $("#association-div").css('border', '0');
            $("#association-div").css('display', 'block');
            $("#association-div").append($(btn));
        }
        if (flag) {
            $("#association-div").css('display', 'block');
            flag = false;
        }
    }

    /**
     * 新增标签
     */
    function insertTag() {
        var tag = $("#association").val();
        var id = uuid();
        var li = '<li id="selected' + id + '"><a href="javascript:delTag(\'' + id + '\');">' + tag + '<i class="icon_close_alt bs_ttip"></i></a></li>';
        $("#select_tags").append($(li));
        addArray("selected" + id);
    }

    /**
     * 添加标签
     */
    function addTag(id, tag) {
        console.log(id);
        console.log(tag);
        var li = '<li id="selected' + id + '"><a href="javascript:delTag(\'' + id + '\');">' + tag + '<i class="icon_close_alt bs_ttip"></i></a></li>';
        $("#select_tags").append($(li));
        addArray("selected" + id);
    }

    /**
     * 删除标签
     */
    function delTag(id) {
        console.log(id);
        $("#selected" + id + "").remove();
        reduceArray("selected" + id);
    }

    function select() {
        //组装传输对象
        var loginInfoValue = new Object();
        var params = {
            action: 'select-tag',
            data: ""
        };
        var res;
        //AJAX请求
        $.ajax({
            async: false, //禁止异步
            url: "/DCMServer/goodLuckToDd/back",
            type: "post",
            data: {
                params: JSON.stringify(params)
            },
            dataType: "json",
            success: function (json) {
                /*
                $("#message").html(json.message);
                //成功跳转
                if(json.status.toString() == '1'){
                     window.location.href="index.html";
                }
                */
                console.log("成功 >>> ");
                console.log(json);
                res = json;
            },
            error: function (json) {
                /*
                alert(json.message);
                $("#message").html(json.message);
                */
                console.log("失败");
                console.log(json);
                res = json;
            }
        });
        return res;
    }

    function uuid() {
        var s = [];
        var hexDigits = "0123456789abcdef";
        for (var i = 0; i < 36; i++) {
            s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
        }
        s[14] = "4";  // bits 12-15 of the time_hi_and_version field to 0010
        s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);  // bits 6-7 of the clock_seq_hi_and_reserved to 01
        s[8] = s[13] = s[18] = s[23] = "_";

        var uuid = s.join("");
        return uuid;
    }


    function isFocus(e) {
        alert(UE.getEditor('editor').isFocus());
        UE.dom.domUtils.preventDefault(e)
    }

    function setblur(e) {
        UE.getEditor('editor').blur();
        UE.dom.domUtils.preventDefault(e)
    }

    function insertHtml() {
        var value = prompt('插入html代码', '');
        UE.getEditor('editor').execCommand('insertHtml', value)
    }

    function createEditor() {
        enableBtn();
        UE.getEditor('editor');
    }

    function getAllHtml() {
        alert(UE.getEditor('editor').getAllHtml())
    }

    function getContent() {
        var arr = [];
        arr.push("使用editor.getContent()方法可以获得编辑器的内容");
        arr.push("内容为：");
        arr.push(UE.getEditor('editor').getContent());
        alert(arr.join("\n"));
    }

    function getPlainTxt() {
        var arr = [];
        arr.push("使用editor.getPlainTxt()方法可以获得编辑器的带格式的纯文本内容");
        arr.push("内容为：");
        arr.push(UE.getEditor('editor').getPlainTxt());
        alert(arr.join('\n'))
    }

    function setContent(isAppendTo) {
        var arr = [];
        arr.push("使用editor.setContent('欢迎使用ueditor')方法可以设置编辑器的内容");
        UE.getEditor('editor').setContent('欢迎使用ueditor', isAppendTo);
        alert(arr.join("\n"));
    }

    function setDisabled() {
        UE.getEditor('editor').setDisabled('fullscreen');
        disableBtn("enable");
    }

    function setEnabled() {
        UE.getEditor('editor').setEnabled();
        enableBtn();
    }

    function getText() {
        //当你点击按钮时编辑区域已经失去了焦点，如果直接用getText将不会得到内容，所以要在选回来，然后取得内容
        var range = UE.getEditor('editor').selection.getRange();
        range.select();
        var txt = UE.getEditor('editor').selection.getText();
        alert(txt);
    }

    function getContentTxt() {
        var arr = [];
        arr.push("使用editor.getContentTxt()方法可以获得编辑器的纯文本内容");
        arr.push("编辑器的纯文本内容为：");
        arr.push(UE.getEditor('editor').getContentTxt());
        console.log(arr.join("\n"));
        return arr.join("\n");
    }

    function hasContent() {
        var arr = [];
        arr.push("使用editor.hasContents()方法判断编辑器里是否有内容");
        arr.push("判断结果为：");
        arr.push(UE.getEditor('editor').hasContents());
        alert(arr.join("\n"));
    }

    function setFocus() {
        UE.getEditor('editor').focus();
    }

    function deleteEditor() {
        disableBtn();
        UE.getEditor('editor').destroy();
    }

    function disableBtn(str) {
        var div = document.getElementById('btns');
        var btns = UE.dom.domUtils.getElementsByTagName(div, "button");
        for (var i = 0, btn; btn = btns[i++];) {
            if (btn.id == str) {
                UE.dom.domUtils.removeAttributes(btn, ["disabled"]);
            } else {
                btn.setAttribute("disabled", "true");
            }
        }
    }

    function enableBtn() {
        var div = document.getElementById('btns');
        var btns = UE.dom.domUtils.getElementsByTagName(div, "button");
        for (var i = 0, btn; btn = btns[i++];) {
            UE.dom.domUtils.removeAttributes(btn, ["disabled"]);
        }
    }

    function getLocalData() {
        alert(UE.getEditor('editor').execCommand("getlocaldata"));
    }

    function clearLocalData() {
        UE.getEditor('editor').execCommand("clearlocaldata");
        alert("已清空草稿箱")
    }
</script>
</body>

</html>
